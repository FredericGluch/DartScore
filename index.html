<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dart Score</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
}
.app {
    max-width: 480px;
    margin: auto;
    padding: 1rem;
}
h1, h2 {
    text-align: center;
}
.header {
    margin-top: 0;
}
button {
    padding: 0.7rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
}
.players {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}
.player {
    background: #222;
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
}
.player-name {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 0.9rem;
    outline: none;
}
.player-name:focus {
    background: #333;
    border-radius: 4px;
    padding: 2px 4px;
}
.player.active {
    border: 2px solid #0f0;
}
.player .score {
    font-size: 1.2rem;
    text-align: right;
}
.multipliers {
    display: flex;
    gap: 0.5rem;
    margin: .5rem 0;
}
.multipliers button {
    flex: 1;
}
.gameBtnContainer {
    display: flex;
    gap: .5rem;
    margin-bottom: 1rem;
    margin-top: 1rem;
}
.double {
    background: #ff9900;
    padding: 2px;
    height: 40px;
    color: #000;
    font-weight: 700;
}
.double:focus, 
.triple:focus {
    border: 3px solid #fff;
}
.triple { 
    background: #f44336;
    padding: 2px;
    height: 40px;
    color: #000;
    font-weight: 700;
}
.board {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.4rem;
}
.board button {
    background: #333;
    color: #fff;
}

.history {
    margin-top: 1rem;
    background: #222;
    padding: 0.7rem;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    font-size: 0.9rem;
}

.setup {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    background: #222;
    padding: 1rem;
    border-radius: 10px;
    max-width: 400px;
    margin: 1rem auto;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
}

.setup-row {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
}

.setup-row label {
    font-size: 0.9rem;
    color: #ccc;
}

.setup-row input {
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #555;
    background: #111;
    color: #fff;
    font-size: 1rem;
    width: 100%;
    box-sizing: border-box;
}

.start-btn {
    margin-top: 0.5rem;
    padding: 0.6rem;
    border: none;
    border-radius: 6px;
    background: #4caf50;
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}

.setup-startscore {
    display: flex;
    gap: .5rem;

    button {
        background: rgb(58, 58, 58);
        color: #fff;
        width: 100%;
    }
}

</style>
</head>
<body>

<div class="app">
    <h1 id="header" class="header">ðŸŽ¯ Dart Score</h1>

<div class="setup" id="setup">
    <div class="setup-row">
        <label for="playerCount">How many are playing?</label>
        <input type="number" id="playerCount" min="1" value="2">
    </div>
    <div class="setup-row">
        <label for="startScore">Choose startscore:</label>
        <div class="setup-startscore">
            <button onclick="startGame(501)">501</button>
            <button onclick="startGame(301)">301</button>
        </div>
    </div>

    <!-- HIIDEN -->
    <button class="start-btn" style="display: none;" onclick="startTournament()">Start tournament</button>
</div>

<div class="tournament" id="tournament" style="display:none;">
    <h1>Tournament Draft</h1>
</div>

    <div id="game" style="display:none;">
        <div class="players" id="players"></div>

        <h2 id="turnInfo"></h2>
        
        <div class="multipliers">
            <button class="double" onclick="setMulti(2)">Double</button>
            <button class="triple" onclick="setMulti(3)">Triple</button>
        </div>

        <button onclick="undo()" style="width:100%; margin-bottom:0.5rem; background:#607d8b; color:#fff;">â†© Undo</button>

        <div class="board" id="board"></div>

        <div class="gameBtnContainer">
            <button onclick="newGame()" style="width:100%; margin-bottom:0.5rem; background:hsla(124, 90%, 54%, 0.843); color:#fff;">Neues Spiel</button>
            <button onclick="restartGame()" style="width:100%; margin-bottom:0.5rem; background:#2191f3; color:#fff;">Restart</button>
        </div>

        <div class="history" id="history"></div>
    </div>
</div>

<script>
let players = [];
let current = 0;
let dartsLeft = 3;
let multiplier = 1;
let historyStack = [];
let round = 1;
let startScore = 0;

// --- Local Storage Funktionen ---
function saveState() {
    const state = {
        players,
        current,
        dartsLeft,
        multiplier,
        historyStack
    };
   localStorage.setItem('dartGameState', JSON.stringify(state));
}

function startTournament() {
    setup.style.display = "none";
    header.style.display = "none";
    tournament.style.display = "block";
}

function changeName(index, newName) {
    if (!newName.trim()) return;
    players[index].name = newName.trim();
    saveState();
}

function loadState() {
    const state = localStorage.getItem('dartGameState');
    if (state) {
        const data = JSON.parse(state);
        players = data.players || [];
        current = data.current || 0;
        dartsLeft = data.dartsLeft || 3;
        multiplier = data.multiplier || 1;
        historyStack = data.historyStack || [];

        setup.style.display = "none";
        game.style.display = "block";

        renderPlayers();
        renderBoard();
        updateRound();
    }
}

function restartGame() {
    localStorage.removeItem('dartGameState');
    historyStack = [];
    players = [];
    current = 0;
    dartsLeft = 3;
    multiplier = 1;

    document.getElementById("history").innerHTML = "";

    const startScore = JSON.parse(localStorage.getItem('startScore'));
    startGame(startScore);
}

// --- Spielstart ---
function startGame(score) {
    localStorage.setItem("startScore", JSON.stringify(score));
    const count = parseInt(playerCount.value);
    if (count < 1 || score < 1) return;

    players = Array.from({ length: count }, (_, i) => ({
        name: "",
        score: score,
        totalPoints: 0,
        rounds: 0,
        avg: 0,
        turnPoints: 0
    }));

    setup.style.display = "none";
    game.style.display = "block";

    historyStack = [];
    current = 0;
    dartsLeft = 3;
    multiplier = 1;

    renderPlayers();
    renderBoard();
    updateRound();
    saveState();
}

function renderPlayers() {
    const playersDiv = document.getElementById("players");
    playersDiv.innerHTML = "";

    players.forEach((p, i) => {
        playersDiv.innerHTML += `
            <div class="player ${i === current ? "active" : ""}">
                <input 
                    placeholder="Click here to enter a name"
                    class="player-name"
                    value="${p.name}"
                    onchange="changeName(${i}, this.value)"
                >
                <span>avg: ${p.avg}</span>
                <span class="score">${p.score}</span>
            </div>`;
    });
}

function calculatePoints(hit, multiplier) {
    if (hit === "MISS") return 0;
    if (hit === "BULL") return 25;
    if (hit === "BULLSEYE") return 50;

    // Normal numbers (1â€“20)
    return hit * multiplier;
}


function renderBoard() {
    const board = document.getElementById("board");
    board.innerHTML = "";
    for (let i = 1; i <= 20; i++) {
        board.innerHTML += `<button onclick="throwDart(${i})">${i}</button>`;
    }
    board.innerHTML += `
        <button onclick="throwDart('BULL')">Bull</button>
        <button onclick="throwDart('BULLSEYE')">Bullseye</button>
        <button onclick="throwDart('MISS')">Miss</button>`;
}

function setMulti(m) {
    multiplier = m;
    saveState();
}

function throwDart(hit) {
    // Vorherigen Zustand speichern
    historyStack.push({
        players: JSON.parse(JSON.stringify(players)),
        current,
        dartsLeft,
        multiplier,
        historyHTML: document.getElementById("history").innerHTML
    });

    let player = players[current];
    const points = calculatePoints(hit, multiplier);

    dartsLeft--;
    player.turnPoints += points;
    
    const isDoubleFinish = (multiplier === 2 && typeof hit === "number") || hit === "BULLSEYE";
    const newScore = player.score - points;
    
    
    if (newScore < 0 || newScore === 1 || (newScore === 0 && !isDoubleFinish)) {
        log(`âŒ ${player.name} Bust`);

        player.turnPoints = 0;
        player.rounds++;
        player.avg = (player.totalPoints / player.rounds).toFixed(2);

        endTurn();
        renderPlayers();
        saveState();
        return;
    }

    player.score = newScore;
    log(`ðŸŽ¯ ${player.name}: ${points}`);

    if (newScore === 0) {
        alert(`ðŸ† ${player.name} gewinnt!`);
        //localStorage.removeItem('dartGameState');
        //location.reload();
        //startGame();
    }

    if (dartsLeft === 0) { 
        player.totalPoints += player.turnPoints;
        player.rounds++;
        player.avg = (player.totalPoints / player.rounds).toFixed(2);

        player.turnPoints = 0; // reset fÃ¼r nÃ¤chste Runde
        endTurn();
    }

    renderPlayers();
    saveState();
    setMulti(1);
}

function endTurn() {
    dartsLeft = 3;
    current = (current + 1) % players.length;
    updateRound();
    saveState();
}

function updateRound() {
    document.getElementById("turnInfo").textContent = `Round: ${players[current].rounds + 1}`;
}

function log(text) {
    const h = document.getElementById("history");
    h.innerHTML = `<div>${text}</div>` + h.innerHTML;
    saveState();
}

function undo() {
    if (historyStack.length === 0) return;

    const last = historyStack.pop();

    players = last.players;
    current = last.current;
    dartsLeft = last.dartsLeft;
    multiplier = last.multiplier;

    document.getElementById("history").innerHTML = last.historyHTML;

    renderPlayers();
    updateRound();
    saveState();
}


// --- Neues Spiel Funktion ---
function newGame() {
    localStorage.removeItem('dartGameState');
    historyStack = [];
    players = [];
    current = 0;
    dartsLeft = 3;
    multiplier = 1;

    setup.style.display = "flex";
    game.style.display = "none";
    document.getElementById("players").innerHTML = "";
    document.getElementById("board").innerHTML = "";
    document.getElementById("history").innerHTML = "";
    document.getElementById("turnInfo").textContent = "";
}

// --- Beim Laden prÃ¼fen ---
window.onload = loadState;
</script>

</body>
</html>
